import React, { useState, useMemo } from 'react';

// Traductor reversible "C. FlyZap <-> Todo" estilo retro terminal
// Interfaz tipo PC antigua (verde sobre negro)

const base64Chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';

function mulberry32(a) {
  return function() {
    var t = (a += 0x6D2B79F5) | 0;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}

function seededShuffle(arr, seed) {
  const a = arr.slice();
  let h = 2166136261 >>> 0;
  for (let i = 0; i < seed.length; i++) {
    h = Math.imul(h ^ seed.charCodeAt(i), 16777619) >>> 0;
  }
  const rand = mulberry32(h);
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(rand() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function buildMapping(seed) {
  const printable = [];
  for (let c = 33; c <= 126; c++) printable.push(String.fromCharCode(c));
  const shuffled = seededShuffle(printable, seed + '_flyzap');
  const mappingChars = shuffled.slice(0, base64Chars.length);
  const map = {};
  const inv = {};
  for (let i = 0; i < base64Chars.length; i++) {
    map[base64Chars[i]] = mappingChars[i];
    inv[mappingChars[i]] = base64Chars[i];
  }
  return { map, inv };
}

function encodeToFlyzap(input, map) {
  try {
    const b64 = btoa(unescape(encodeURIComponent(input)));
    return Array.from(b64).map(ch => map[ch] ?? ch).join('');
  } catch (e) {
    return 'Error al codificar: ' + e.message;
  }
}

function decodeFromFlyzap(input, inv) {
  try {
    const b64 = Array.from(input).map(ch => inv[ch] ?? ch).join('');
    const decoded = decodeURIComponent(escape(atob(b64)));
    return decoded;
  } catch (e) {
    return 'Error al decodificar: ' + e.message;
  }
}

export default function FlyZapTranslator() {
  const seed = 'FlyZap';
  const [direction, setDirection] = useState('todo-to-flyzap');
  const [input, setInput] = useState('');
  const [output, setOutput] = useState('');

  const { map, inv } = useMemo(() => buildMapping(seed), []);

  function translate() {
    if (direction === 'todo-to-flyzap') {
      setOutput(encodeToFlyzap(input, map));
    } else {
      setOutput(decodeFromFlyzap(input, inv));
    }
  }

  function swap() {
    const newDir = direction === 'todo-to-flyzap' ? 'flyzap-to-todo' : 'todo-to-flyzap';
    setDirection(newDir);
    setInput(output);
    setOutput('');
  }

  function copyOutput() {
    navigator.clipboard?.writeText(output);
  }

  return (
    <div className="min-h-screen bg-black text-green-500 font-mono p-8">
      <div className="max-w-4xl mx-auto border-2 border-green-500 rounded-xl p-6 shadow-lg shadow-green-800 animate-pulse-slow">
        <header className="mb-4">
          <h1 className="text-2xl mb-1 tracking-wider">C. FlyZap — Traductor Retro</h1>
          <p className="text-green-400 text-sm">Sistema reversible de conversión estilo terminal</p>
        </header>

        <div className="flex gap-3 mb-4">
          <button
            onClick={() => setDirection('todo-to-flyzap')}
            className={`px-3 py-1 border border-green-500 ${direction === 'todo-to-flyzap' ? 'bg-green-700 text-black' : 'bg-black text-green-400'}`}
          >
            Todo → C. FlyZap
          </button>
          <button
            onClick={() => setDirection('flyzap-to-todo')}
            className={`px-3 py-1 border border-green-500 ${direction === 'flyzap-to-todo' ? 'bg-green-700 text-black' : 'bg-black text-green-400'}`}
          >
            C. FlyZap → Todo
          </button>
          <button onClick={swap} className="ml-auto px-3 py-1 border border-green-400 text-green-400">Intercambiar</button>
        </div>

        <div className="grid md:grid-cols-2 gap-4">
          <div>
            <label className="block text-green-300 text-sm mb-1">Entrada ({direction === 'todo-to-flyzap' ? 'Todo' : 'C. FlyZap'})</label>
            <textarea
              value={input}
              onChange={e => setInput(e.target.value)}
              rows={8}
              className="w-full p-3 bg-black border border-green-700 text-green-400 focus:outline-none focus:border-green-500"
              placeholder={direction === 'todo-to-flyzap' ? 'Escribe texto normal aquí...' : 'Pega texto C. FlyZap aquí...'}
            ></textarea>
            <div className="flex gap-2 mt-2">
              <button onClick={translate} className="px-4 py-2 border border-green-500 text-green-400">Traducir</button>
              <button onClick={() => { setInput(''); setOutput(''); }} className="px-4 py-2 border border-green-700 text-green-500">Limpiar</button>
            </div>
          </div>

          <div>
            <label className="block text-green-300 text-sm mb-1">Salida ({direction === 'todo-to-flyzap' ? 'C. FlyZap' : 'Todo'})</label>
            <textarea
              value={output}
              readOnly
              rows={8}
              className="w-full p-3 bg-black border border-green-700 text-green-400 font-mono animate-blink"
              placeholder="Aquí aparecerá la traducción..."
            ></textarea>
            <div className="flex gap-2 mt-2">
              <button onClick={copyOutput} className="px-4 py-2 border border-green-500 text-green-400">Copiar salida</button>
              <button onClick={() => { setOutput(''); }} className="px-4 py-2 border border-green-700 text-green-500">Limpiar salida</button>
            </div>
          </div>
        </div>

        <footer className="text-green-600 text-xs mt-4 border-t border-green-700 pt-2">
          <p>© 1985 C. FlyZap Systems — Traducción reversible experimental.</p>
        </footer>
      </div>
    </div>
  );
}
